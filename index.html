<!doctype html>
<html class="no-js" lang="">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<title>Point processes in JS</title>
		<meta name="description" content="">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<link rel="apple-touch-icon" href="apple-touch-icon.png">
		<!-- Place favicon.ico in the root directory -->

		<link rel="stylesheet" href="css/main.css">
		<script src="./scripts/vendor/d3.js"></script>
		<script src="./scripts/vendor/dat.gui.js"></script>
		<script src="./scripts/vendor/lodash.js"></script>
	</head>
	<body>
		<h1>Point processes in JS</h1>
		<script type="text/javascript">
			"use strict";
			var MAX_POINTS;
			var allXs, allYs, allTs;
			var xs, ys, ts;
			var deathPtr = 0;
			var birthPtr = 0;
			var simTimer;
			var lastTime = Date.now()/1000; //seconds, for sanity
			var immigrationRate = 2.0;
			var maxX = 1;
			var maxY = 1;
			var stepCtr = 0;
			var stepperHandle;
			var stepperMinInterval = 150; //ms, for JS compatibility
			var stepping = false;
			
			MAX_POINTS = 1024;
			allXs = new Float32Array(MAX_POINTS);
			allYs = new Float32Array(MAX_POINTS);
			allTs = new Float32Array(MAX_POINTS);
			
			function poissonRVlite(mu) {
				/* quick and dirty fake Poisson,
				using exp sum. 
				http://www.johndcook.com/blog/2010/06/14/generating-poisson-random-values/
				Keep mu small and it will be ok.
				*/
				var k, M, p;
				M = Math.exp(-mu);
				p = 1;
				for (k = 0; p > M; k++) {
					p *= Math.random()
				}
				return k - 1;
			};
			function updatePoints(thisTime) {
				var nImmigrants, timeDelta;
				stepCtr += 1;
				timeDelta = thisTime - lastTime;
				console.debug(stepCtr, timeDelta, immigrationRate * timeDelta);
				nImmigrants = poissonRVlite(immigrationRate * timeDelta);
				for (var i = 0; i < nImmigrants; i++) {
					var newX, newY;
					birthPtr = birthPtr + 1 % MAX_POINTS;
					newX = Math.random() * maxX;
					newY = Math.random() * maxY;
					allXs[birthPtr] = newX;
					allYs[birthPtr] = newY;
					allTs[birthPtr] = lastTime;
				}
				lastTime = thisTime;
			}
			function stepAndSchedule() {
				var ret = updatePoints(Date.now()/1000);
				stepperHandle = window.setTimeout(
					stepAndSchedule, stepperMinInterval
				);
			}
			function start() {
				stepAndSchedule();
			}
			function stop() {
				window.clearTimeout(stepperHandle);
			}
			start();
		</script>
	</body>
</html>
